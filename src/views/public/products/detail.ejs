<div class="container product-detail-container">
    <!-- Back Button -->
    <div class="back-button-container">
        <a href="/products" class="btn btn-secondary">
            <i data-lucide="arrow-left"></i>
            Back to Products
        </a>
    </div>

    <div class="card" style="position: relative;">
        <!-- Share Button -->
        <button id="shareButton"
            style="position: absolute; top: 1rem; right: 1rem; z-index: 10; background: white; border: 1px solid #ddd; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;"
            title="Share this product">
            <i data-lucide="share-2" style="width: 20px; height: 20px;"></i>
        </button>

        <div class="product-grid">
            <!-- Product Images -->
            <div class="product-images">
                <% if (product.images && product.images.length> 0) { %>
                    <div id="mainImage" class="main-image"
                        style="background-image: url('<%= product.images[0].url %>');"
                        data-current-url="<%= product.images[0].url %>">
                    </div>
                    <div class="thumbnails-grid">
                        <% product.images.forEach((image, index)=> { %>
                            <img src="<%= image.url %>" alt="<%= image.alt %>" class="thumbnail">
                            <% }); %>
                    </div>
                    <% } else { %>
                        <div
                            style="width: 100%; height: 500px; background: #e0e0e0; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                            <i data-lucide="image" style="width: 96px; height: 96px; opacity: 0.3;"></i>
                        </div>
                        <% } %>
            </div>

            <!-- Product Details -->
            <div class="product-info">
                <% if (product.category) { %>
                    <a href="/categories/<%= product.category.slug %>" class="badge badge-secondary"
                        style="text-decoration: none; margin-bottom: 1rem; display: inline-block;">
                        <%= product.category.name %>
                    </a>
                    <% } %>

                        <h1 style="margin: 0 0 1rem; font-size: 2rem; font-weight: bold;">
                            <%= product.name %>
                        </h1>

                        <div class="price-container">
                            <span style="font-size: 2rem; font-weight: bold; color: var(--primary);">
                                $<%= product.price.toFixed(2) %>
                            </span>
                            <% if (product.comparePrice && product.comparePrice> product.price) { %>
                                <span class="text-muted" style="text-decoration: line-through; font-size: 1.25rem;">
                                    $<%= product.comparePrice.toFixed(2) %>
                                </span>
                                <span class="badge badge-danger">
                                    Save <%= Math.round(((product.comparePrice - product.price) / product.comparePrice)
                                        * 100) %>%
                                </span>
                                <% } %>
                        </div>

                        <div class="stock-info">
                            <div class="flex items-center gap-sm" style="margin-bottom: 0.5rem;">
                                <i data-lucide="package" style="width: 20px; height: 20px;"></i>
                                <strong>Stock:</strong>
                                <% if (product.stock> 0) { %>
                                    <span class="badge badge-success">Available</span>
                                    <% } else { %>
                                        <span class="badge badge-danger">Out of Stock</span>
                                        <% } %>
                            </div>
                        </div>

                        <div style="margin-bottom: 2rem;">
                            <h3 style="margin: 0 0 0.5rem; font-size: 1.25rem;">Description</h3>
                            <p style="line-height: 1.6; color: #666;">
                                <%= product.description %>
                            </p>
                        </div>

                        <% if (product.stock> 0) { %>
                            <% if (isAuthenticated && userRole !=='admin' ) { %>
                                <form action="/cart/add" method="POST" class="add-to-cart-form">
                                    <% if (typeof csrfToken !=='undefined' ) { %>
                                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                        <% } %>
                                            <input type="hidden" name="productId" value="<%= product._id %>">
                                            <input type="hidden" name="quantity" value="1">
                                            <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                                                <i data-lucide="shopping-cart"></i>
                                                Add to Cart
                                            </button>
                                </form>
                                <% } else if (isAuthenticated && userRole==='admin' ) { %>
                                    <button class="btn btn-secondary btn-lg" style="width: 100%;" disabled>
                                        <i data-lucide="shield"></i>
                                        Admin cannot add to cart
                                    </button>
                                    <% } else { %>
                                        <a href="/auth/login" class="btn btn-primary btn-lg"
                                            style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem; text-decoration: none;">
                                            <i data-lucide="log-in"></i>
                                            Login to Add to Cart
                                        </a>
                                        <% } %>
                                            <% } else { %>
                                                <button class="btn btn-secondary btn-lg" style="width: 100%;" disabled>
                                                    <i data-lucide="x-circle"></i>
                                                    Out of Stock
                                                </button>
                                                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- Related Products Section -->
<% if (relatedProducts && relatedProducts.length> 0) { %>
    <div class="container" style="margin-top: 3rem;">
        <h2 style="font-size: 1.75rem; font-weight: bold; margin-bottom: 1.5rem;">Related Products</h2>
        <div class="related-products-grid">
            <% relatedProducts.forEach(relatedProduct=> { %>
                <a href="/products/<%= relatedProduct.slug %>" class="related-product-card">
                    <div class="related-product-image">
                        <% if (relatedProduct.images && relatedProduct.images.length> 0) { %>
                            <img src="<%= relatedProduct.images[0].url %>" alt="<%= relatedProduct.name %>">
                            <% } else { %>
                                <div class="related-product-placeholder">
                                    <i data-lucide="image" style="width: 48px; height: 48px; opacity: 0.3;"></i>
                                </div>
                                <% } %>
                    </div>
                    <div class="related-product-info">
                        <h3 class="related-product-name">
                            <%= relatedProduct.name %>
                        </h3>
                        <div class="related-product-price">
                            <span class="price-current">$<%= relatedProduct.price.toFixed(2) %></span>
                            <% if (relatedProduct.comparePrice && relatedProduct.comparePrice> relatedProduct.price) {
                                %>
                                <span class="price-compare">$<%= relatedProduct.comparePrice.toFixed(2) %></span>
                                <% } %>
                        </div>
                    </div>
                </a>
                <% }); %>
        </div>
    </div>
    <% } %>

        <div id="imageModal"
            style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.95); cursor: zoom-out;">
            <span
                style="position: absolute; top: 20px; right: 40px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 10000;">&times;</span>
            <img id="modalImage"
                style="margin: auto; display: block; max-width: 90%; max-height: 90%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 8px; cursor: zoom-in;">
        </div>

        <script>
            (function () {
                'use strict';

                const shareButton = document.getElementById('shareButton');
                console.log('Share button element:', shareButton);

                if (shareButton) {
                    // Add hover effects
                    shareButton.addEventListener('mouseenter', function () {
                        this.style.background = '#f5f5f5';
                        this.style.transform = 'scale(1.05)';
                    });

                    shareButton.addEventListener('mouseleave', function () {
                        this.style.background = 'white';
                        this.style.transform = 'scale(1)';
                    });

                    // Share functionality
                    shareButton.addEventListener('click', async function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Share button clicked!');

                        const url = window.location.href;
                        const title = '<%= product.name %>';

                        // Check if Web Share API is available
                        if (navigator.share) {
                            console.log('Using Web Share API');
                            try {
                                await navigator.share({
                                    title: title,
                                    url: url
                                });
                                console.log('Share successful');
                            } catch (err) {
                                if (err.name !== 'AbortError') {
                                    console.error('Error sharing:', err);
                                }
                            }
                        } else {
                            // Fallback: Copy to clipboard
                            console.log('Using clipboard fallback');
                            try {
                                await navigator.clipboard.writeText(url);
                                console.log('Link copied to clipboard');

                                // Show success feedback
                                const originalHTML = shareButton.innerHTML;
                                shareButton.innerHTML = '<i data-lucide="check" style="width: 20px; height: 20px;"></i>';
                                shareButton.style.background = '#10b981';
                                shareButton.style.color = 'white';
                                shareButton.style.borderColor = '#10b981';

                                // Re-initialize lucide icons
                                if (typeof lucide !== 'undefined') {
                                    lucide.createIcons();
                                }

                                setTimeout(function () {
                                    shareButton.innerHTML = originalHTML;
                                    shareButton.style.background = 'white';
                                    shareButton.style.color = '';
                                    shareButton.style.borderColor = '#ddd';
                                    if (typeof lucide !== 'undefined') {
                                        lucide.createIcons();
                                    }
                                }, 2000);
                            } catch (err) {
                                console.error('Failed to copy:', err);
                                alert('Failed to copy link. Error: ' + err.message);
                            }
                        }
                    });
                } else {
                    console.error('Share button not found!');
                }
            })();
        </script>