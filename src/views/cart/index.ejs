<div class="container">
    <h1 style="margin-bottom: 2rem; font-size: 2rem;">Shopping Cart</h1>

    <% if (error) { %>
        <div class="alert alert-danger" role="alert">
            <%= error %>
        </div>
        <% } %>

            <% if (success) { %>
                <div class="alert alert-success" role="alert">
                    <%= success %>
                </div>
                <% } %>

                    <% if (cart.items.length===0) { %>
                        <div class="card text-center" style="padding: 3rem;">
                            <i data-lucide="shopping-cart"
                                style="width: 64px; height: 64px; margin: 0 auto 1rem; opacity: 0.3;"></i>
                            <h2 style="margin-bottom: 1rem;">Your cart is empty</h2>
                            <p class="text-muted" style="margin-bottom: 2rem;">Start shopping to add items to your cart
                            </p>
                            <a href="/products" class="btn btn-primary">Browse Products</a>
                        </div>
                        <% } else { %>
                            <div class="cart-layout">
                                <!-- Cart Items -->
                                <div class="cart-items-section">
                                    <div class="card">
                                        <h2 style="margin-bottom: 1.5rem; font-size: 1.5rem;">Cart Items</h2>

                                        <% cart.items.forEach(item=> { %>
                                            <div class="cart-item" data-product-id="<%= item.product._id %>">
                                                <div class="cart-item-image">
                                                    <% if (item.product.images && item.product.images.length> 0) { %>
                                                        <img src="<%= item.product.images[0].url %>"
                                                            alt="<%= item.product.images[0].alt || item.product.name %>">
                                                        <% } else { %>
                                                            <div
                                                                style="width: 100%; height: 100%; background: #e0e0e0; display: flex; align-items: center; justify-content: center;">
                                                                <i data-lucide="image"
                                                                    style="width: 32px; height: 32px; opacity: 0.3;"></i>
                                                            </div>
                                                            <% } %>
                                                </div>

                                                <div class="cart-item-details">
                                                    <h3 style="margin: 0 0 0.5rem; font-size: 1.125rem;">
                                                        <a href="/products/<%= item.product.slug %>"
                                                            style="text-decoration: none; color: inherit;">
                                                            <%= item.product.name %>
                                                        </a>
                                                    </h3>
                                                    <p class="text-muted" style="margin: 0;">
                                                        $<%= item.price.toFixed(2) %> each
                                                    </p>

                                                    <% if (!item.product.isActive) { %>
                                                        <span class="badge badge-danger"
                                                            style="margin-top: 0.5rem;">Product unavailable</span>
                                                        <% } else if (item.product.stock < item.quantity) { %>
                                                            <span class="badge badge-warning"
                                                                style="margin-top: 0.5rem;">
                                                                Only <%= item.product.stock %> left in stock
                                                            </span>
                                                            <% } %>
                                                </div>

                                                <div class="cart-item-quantity">
                                                    <button class="btn btn-sm btn-secondary qty-btn"
                                                        data-action="decrease" data-product-id="<%= item.product._id %>"
                                                        <% if (item.quantity <=1) { %>disabled<% } %>>
                                                            <i data-lucide="minus"></i>
                                                    </button>
                                                    <input type="number" class="qty-input" value="<%= item.quantity %>"
                                                        min="1" max="<%= item.product.stock %>"
                                                        data-product-id="<%= item.product._id %>">
                                                    <button class="btn btn-sm btn-secondary qty-btn"
                                                        data-action="increase" data-product-id="<%= item.product._id %>"
                                                        <% if (item.quantity>= item.product.stock) { %>disabled<% } %>>
                                                            <i data-lucide="plus"></i>
                                                    </button>
                                                </div>

                                                <div class="cart-item-total">
                                                    <strong style="font-size: 1.125rem;">
                                                        $<span class="item-total">
                                                            <%= (item.price * item.quantity).toFixed(2) %>
                                                        </span>
                                                    </strong>
                                                </div>

                                                <div class="cart-item-remove">
                                                    <button class="btn btn-sm btn-danger remove-btn"
                                                        data-product-id="<%= item.product._id %>">
                                                        <i data-lucide="trash-2"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <% }); %>

                                                <div
                                                    style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #dee2e6;">
                                                    <button class="btn btn-secondary" id="clearCartBtn">
                                                        <i data-lucide="trash-2"></i>
                                                        Clear Cart
                                                    </button>
                                                </div>
                                    </div>
                                </div>

                                <!-- Cart Summary -->
                                <div class="cart-summary-section">
                                    <div class="card cart-summary">
                                        <h2 style="margin-bottom: 1.5rem; font-size: 1.5rem;">Order Summary</h2>

                                        <div
                                            style="margin-bottom: 1rem; display: flex; justify-content: space-between;">
                                            <span>Items (<span id="totalItems">
                                                    <%= cart.totalItems %>
                                                </span>):</span>
                                            <strong>$<span id="totalPrice">
                                                    <%= cart.totalPrice.toFixed(2) %>
                                                </span></strong>
                                        </div>

                                        <div
                                            style="margin-bottom: 1.5rem; padding-top: 1rem; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between; font-size: 1.25rem;">
                                            <strong>Total:</strong>
                                            <strong style="color: var(--primary);">$<span id="grandTotal">
                                                    <%= cart.totalPrice.toFixed(2) %>
                                                </span></strong>
                                        </div>

                                        <button class="btn btn-primary btn-lg" style="width: 100%;" disabled>
                                            <i data-lucide="credit-card"></i>
                                            Proceed to Checkout (Coming Soon)
                                        </button>

                                        <a href="/products" class="btn btn-secondary"
                                            style="width: 100%; margin-top: 1rem;">
                                            <i data-lucide="arrow-left"></i>
                                            Continue Shopping
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <% } %>
</div>

<% if (typeof csrfToken !=='undefined' ) { %>
    <input type="hidden" id="csrfToken" value="<%= csrfToken %>">
    <% } %>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                lucide.createIcons();

                const csrfToken = document.getElementById('csrfToken')?.value;

                // Update quantity handlers
                document.querySelectorAll('.qty-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const productId = e.currentTarget.dataset.productId;
                        const action = e.currentTarget.dataset.action;
                        const input = document.querySelector(`.qty-input[data-product-id="${productId}"]`);
                        const currentQty = parseInt(input.value);
                        const newQty = action === 'increase' ? currentQty + 1 : currentQty - 1;

                        if (newQty < 1) return;

                        await updateQuantity(productId, newQty);
                    });
                });

                // Direct input change
                document.querySelectorAll('.qty-input').forEach(input => {
                    input.addEventListener('change', async (e) => {
                        const productId = e.target.dataset.productId;
                        const newQty = parseInt(e.target.value);

                        if (newQty < 1 || isNaN(newQty)) {
                            e.target.value = 1;
                            return;
                        }

                        await updateQuantity(productId, newQty);
                    });
                });

                // Remove item handlers
                document.querySelectorAll('.remove-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const productId = e.currentTarget.dataset.productId;
                        if (confirm('Remove this item from cart?')) {
                            await removeItem(productId);
                        }
                    });
                });

                // Clear cart handler
                const clearCartBtn = document.getElementById('clearCartBtn');
                if (clearCartBtn) {
                    clearCartBtn.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to clear your cart?')) {
                            try {
                                const response = await fetch('/cart/clear', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        ...(csrfToken && { 'X-CSRF-Token': csrfToken })
                                    }
                                });

                                if (response.ok) {
                                    window.location.reload();
                                } else {
                                    const data = await response.json();
                                    alert(data.message || 'Failed to clear cart');
                                }
                            } catch (error) {
                                console.error('Clear cart error:', error);
                                alert('Failed to clear cart');
                            }
                        }
                    });
                }

                async function updateQuantity(productId, quantity) {
                    try {
                        const response = await fetch('/cart/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                ...(csrfToken && { 'X-CSRF-Token': csrfToken })
                            },
                            body: JSON.stringify({ productId, quantity })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            window.location.reload();
                        } else {
                            alert(data.message || 'Failed to update quantity');
                        }
                    } catch (error) {
                        console.error('Update quantity error:', error);
                        alert('Failed to update quantity');
                    }
                }

                async function removeItem(productId) {
                    try {
                        const response = await fetch('/cart/remove', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                ...(csrfToken && { 'X-CSRF-Token': csrfToken })
                            },
                            body: JSON.stringify({ productId })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            window.location.reload();
                        } else {
                            alert(data.message || 'Failed to remove item');
                        }
                    } catch (error) {
                        console.error('Remove item error:', error);
                        alert('Failed to remove item');
                    }
                }
            });
        </script>