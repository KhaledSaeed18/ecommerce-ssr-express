<div class="container-fluid" style="max-width: 1200px;">
    <div style="margin-bottom: 2rem;">
        <a href="/admin/orders" class="btn btn-secondary" style="margin-bottom: 1rem;">
            <i data-lucide="arrow-left"></i>
            Back to Orders
        </a>
        <h1 style="margin: 0; font-size: 2rem;">Order #<%= order.orderNumber %>
        </h1>
    </div>

    <% if (error) { %>
        <div class="alert alert-error" role="alert">
            <%= error %>
        </div>
        <% } %>

            <% if (success) { %>
                <div class="alert alert-success" role="alert">
                    <%= success %>
                </div>
                <% } %>

                    <div class="order-detail-layout">
                        <!-- Order Status Management -->
                        <div class="order-detail-main">
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                    <h2 style="margin: 0; font-size: 1.5rem;">Order Status Management</h2>
                                    <span class="order-status-badge status-<%= order.status %>"
                                        style="font-size: 1rem; padding: 0.5rem 1rem;">
                                        <%= order.status.charAt(0).toUpperCase() + order.status.slice(1) %>
                                    </span>
                                </div>

                                <% if (order.status==='rejected' && order.rejectionReason) { %>
                                    <div class="alert alert-error" role="alert">
                                        <strong>Rejection Reason:</strong>
                                        <%= order.rejectionReason %>
                                    </div>
                                    <% } %>

                                        <!-- Status Timeline -->
                                        <div class="order-timeline" style="margin-bottom: 1.5rem;">
                                            <% order.statusHistory.reverse().forEach((history, index)=> { %>
                                                <div class="timeline-item <%= index === 0 ? 'active' : '' %>">
                                                    <div class="timeline-marker"></div>
                                                    <div class="timeline-content">
                                                        <div
                                                            style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.25rem;">
                                                            <strong style="text-transform: capitalize;">
                                                                <%= history.status %>
                                                            </strong>
                                                            <span class="text-muted" style="font-size: 0.875rem;">
                                                                <%= new
                                                                    Date(history.updatedAt).toLocaleDateString('en-US',
                                                                    { month: 'short' , day: 'numeric' , year: 'numeric'
                                                                    , hour: '2-digit' , minute: '2-digit' }) %>
                                                            </span>
                                                        </div>
                                                        <% if (history.comment) { %>
                                                            <p class="text-muted"
                                                                style="margin: 0 0 0.25rem; font-size: 0.875rem;">
                                                                <%= history.comment %>
                                                            </p>
                                                            <% } %>
                                                                <% if (history.updatedBy) { %>
                                                                    <p class="text-muted"
                                                                        style="margin: 0; font-size: 0.75rem;">
                                                                        by <%= history.updatedBy.email %>
                                                                    </p>
                                                                    <% } %>
                                                    </div>
                                                </div>
                                                <% }); %>
                                        </div>

                                        <!-- Status Update Form -->
                                        <% const validTransitions={ 'pending' : ['approved', 'rejected' , 'cancelled'
                                            ], 'approved' : ['shipped', 'cancelled' ], 'shipped' :
                                            ['delivered'], 'rejected' : [], 'delivered' : [], 'cancelled' : [] }; const
                                            availableStatuses=validTransitions[order.status] || []; %>

                                            <% if (availableStatuses.length> 0) { %>
                                                <div style="border-top: 1px solid #dee2e6; padding-top: 1.5rem;">
                                                    <h3 style="margin-bottom: 1rem; font-size: 1.125rem;">Update Order
                                                        Status</h3>

                                                    <form action="/admin/orders/<%= order._id %>/status" method="POST"
                                                        id="statusForm">
                                                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">

                                                        <div class="form-group">
                                                            <label for="status" class="form-label required">New
                                                                Status</label>
                                                            <select name="status" id="status" class="form-control"
                                                                required onchange="toggleCommentField()">
                                                                <option value="">Select status...</option>
                                                                <% availableStatuses.forEach(status=> { %>
                                                                    <option value="<%= status %>">
                                                                        <%= status.charAt(0).toUpperCase() +
                                                                            status.slice(1) %>
                                                                    </option>
                                                                    <% }); %>
                                                            </select>
                                                        </div>

                                                        <div class="form-group" id="commentGroup"
                                                            style="display: none;">
                                                            <label for="comment" class="form-label">
                                                                <span id="commentLabel">Comment</span>
                                                            </label>
                                                            <textarea name="comment" id="comment" class="form-control"
                                                                rows="3" placeholder="Enter comment..."></textarea>
                                                            <small class="form-text text-muted">
                                                                <span id="commentHelp"></span>
                                                            </small>
                                                        </div>

                                                        <button type="submit" class="btn btn-primary">
                                                            <i data-lucide="check"></i>
                                                            Update Status
                                                        </button>
                                                    </form>
                                                </div>

                                                <script>
                                                    function toggleCommentField() {
                                                        const status = document.getElementById('status').value;
                                                        const commentGroup = document.getElementById('commentGroup');
                                                        const commentField = document.getElementById('comment');
                                                        const commentLabel = document.getElementById('commentLabel');
                                                        const commentHelp = document.getElementById('commentHelp');

                                                        if (status === 'rejected') {
                                                            commentGroup.style.display = 'block';
                                                            commentField.required = true;
                                                            commentLabel.innerHTML = 'Rejection Reason <span style="color: red;">*</span>';
                                                            commentHelp.textContent = 'Required: Explain why this order is being rejected';
                                                        } else if (status) {
                                                            commentGroup.style.display = 'block';
                                                            commentField.required = false;
                                                            commentLabel.textContent = 'Comment (Optional)';
                                                            commentHelp.textContent = 'Optional: Add any notes about this status change';
                                                        } else {
                                                            commentGroup.style.display = 'none';
                                                            commentField.required = false;
                                                        }
                                                    }
                                                </script>
                                                <% } else { %>
                                                    <div class="alert alert-info" role="alert">
                                                        This order is in final status and cannot be updated further.
                                                    </div>
                                                    <% } %>
                            </div>

                            <!-- Order Items -->
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <h2 style="margin-bottom: 1.5rem; font-size: 1.5rem;">Order Items</h2>

                                <% order.items.forEach(item=> { %>
                                    <div class="order-detail-item">
                                        <div class="order-detail-item-image">
                                            <% if (item.image) { %>
                                                <img src="<%= item.image %>" alt="<%= item.name %>">
                                                <% } else { %>
                                                    <div
                                                        style="width: 100%; height: 100%; background: #e0e0e0; display: flex; align-items: center; justify-content: center;">
                                                        <i data-lucide="image"
                                                            style="width: 32px; height: 32px; opacity: 0.3;"></i>
                                                    </div>
                                                    <% } %>
                                        </div>
                                        <div class="order-detail-item-info">
                                            <h3 style="margin: 0 0 0.5rem; font-size: 1.125rem;">
                                                <% if (item.product && item.product.slug) { %>
                                                    <a href="/products/<%= item.product.slug %>"
                                                        style="text-decoration: none; color: inherit;" target="_blank">
                                                        <%= item.name %>
                                                    </a>
                                                    <% } else { %>
                                                        <%= item.name %>
                                                            <% } %>
                                            </h3>
                                            <p class="text-muted" style="margin: 0 0 0.5rem;">
                                                $<%= item.price.toFixed(2) %> Ã— <%= item.quantity %>
                                            </p>
                                            <% if (item.product) { %>
                                                <div style="font-size: 0.875rem;">
                                                    <% if (!item.product.isActive) { %>
                                                        <span class="badge badge-danger">Product Inactive</span>
                                                        <% } else { %>
                                                            <span class="text-muted">Stock: <%= item.product.stock %>
                                                            </span>
                                                            <% } %>
                                                </div>
                                                <% } %>
                                        </div>
                                        <div class="order-detail-item-total">
                                            <strong style="font-size: 1.125rem;">
                                                $<%= (item.price * item.quantity).toFixed(2) %>
                                            </strong>
                                        </div>
                                    </div>
                                    <% }); %>

                                        <div
                                            style="border-top: 2px solid #dee2e6; margin-top: 1.5rem; padding-top: 1rem; display: flex; justify-content: space-between; font-size: 1.25rem;">
                                            <strong>Total:</strong>
                                            <strong style="color: var(--primary);">$<%= order.totalPrice.toFixed(2) %>
                                            </strong>
                                        </div>
                            </div>

                            <% if (order.notes) { %>
                                <div class="card">
                                    <h3 style="margin-bottom: 1rem; font-size: 1.125rem;">Customer Notes</h3>
                                    <p
                                        style="margin: 0; white-space: pre-wrap; background: #f8f9fa; padding: 1rem; border-radius: 4px;">
                                        <%= order.notes %>
                                    </p>
                                </div>
                                <% } %>
                        </div>

                        <!-- Order Information Sidebar -->
                        <div class="order-detail-sidebar">
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <h3 style="margin-bottom: 1rem; font-size: 1.125rem;">Customer Information</h3>
                                <div class="info-row">
                                    <span class="text-muted">Email:</span>
                                    <span>
                                        <%= order.user.email %>
                                    </span>
                                </div>
                                <div class="info-row">
                                    <span class="text-muted">Phone:</span>
                                    <span>
                                        <%= order.shippingAddress.phone %>
                                    </span>
                                </div>
                            </div>

                            <div class="card" style="margin-bottom: 1.5rem;">
                                <h3 style="margin-bottom: 1rem; font-size: 1.125rem;">Order Information</h3>
                                <div class="info-row">
                                    <span class="text-muted">Order Date:</span>
                                    <span>
                                        <%= new Date(order.createdAt).toLocaleDateString('en-US', { year: 'numeric' ,
                                            month: 'long' , day: 'numeric' , hour: '2-digit' , minute: '2-digit' }) %>
                                    </span>
                                </div>
                                <div class="info-row">
                                    <span class="text-muted">Payment:</span>
                                    <span>Cash on Delivery</span>
                                </div>
                                <div class="info-row">
                                    <span class="text-muted">Total Items:</span>
                                    <span>
                                        <%= order.totalItems %>
                                    </span>
                                </div>
                            </div>

                            <div class="card">
                                <h3 style="margin-bottom: 1rem; font-size: 1.125rem;">Shipping Address</h3>
                                <div style="line-height: 1.8; background: #f8f9fa; padding: 1rem; border-radius: 4px;">
                                    <strong style="display: block; margin-bottom: 0.5rem;">
                                        <%= order.shippingAddress.fullName %>
                                    </strong>
                                    <%= order.shippingAddress.phone %><br>
                                        <%= order.shippingAddress.address %><br>
                                            <%= order.shippingAddress.city %>, <%= order.shippingAddress.postalCode %>
                                </div>
                            </div>
                        </div>
                    </div>
</div>