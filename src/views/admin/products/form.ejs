<div class="card">
    <div class="card-header">
        <h1 class="card-title">
            <%= product ? 'Edit Product' : 'Create Product' %>
        </h1>
        <p class="card-description">
            <%= product ? 'Update product information' : 'Add a new product to your catalog' %>
        </p>
    </div>

    <div class="card-content">
        <% if (typeof success !=='undefined' && success) { %>
            <div class="alert alert-success">
                <%= success %>
            </div>
            <% } %>

                <% if (typeof error !=='undefined' && error) { %>
                    <div class="alert alert-error">
                        <%= error %>
                    </div>
                    <% } %>

                        <form action="<%= product ? `/admin/products/${product._id}` : '/admin/products' %>"
                            method="POST" enctype="multipart/form-data">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">

                            <div class="form-group">
                                <label for="name" class="form-label">Product Name</label>
                                <input type="text" id="name" name="name" class="form-input" required minlength="3"
                                    maxlength="100" value="<%= product ? product.name : '' %>">
                            </div>

                            <div class="form-group">
                                <label for="description" class="form-label">Description</label>
                                <textarea id="description" name="description" class="form-input" rows="6" required
                                    minlength="10" maxlength="2000"><%= product ? product.description : '' %></textarea>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="price" class="form-label">Price ($)</label>
                                    <input type="number" id="price" name="price" class="form-input" required min="0"
                                        step="0.01" value="<%= product ? product.price : '' %>">
                                </div>

                                <div class="form-group">
                                    <label for="comparePrice" class="form-label">Compare Price ($)</label>
                                    <input type="number" id="comparePrice" name="comparePrice" class="form-input"
                                        min="0" step="0.01" value="<%= product ? product.comparePrice : '' %>">
                                    <small class="form-help">Optional: Original price for discount display</small>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="category" class="form-label">Category</label>
                                    <select id="category" name="category" class="form-input" required>
                                        <option value="">Select a category</option>
                                        <% categories.forEach(cat=> { %>
                                            <option value="<%= cat._id %>" <%=product && product.category &&
                                                product.category._id.toString()===cat._id.toString() ? 'selected' : ''
                                                %>>
                                                <%= cat.name %>
                                            </option>
                                            <% }); %>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="stock" class="form-label">Stock Quantity</label>
                                    <input type="number" id="stock" name="stock" class="form-input" required min="0"
                                        value="<%= product ? product.stock : 0 %>">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="sku" class="form-label">SKU (Stock Keeping Unit)</label>
                                <input type="text" id="sku" name="sku" class="form-input"
                                    value="<%= product ? product.sku : '' %>">
                                <small class="form-help">Optional: Unique identifier for inventory management</small>
                            </div>

                            <!-- Existing Images -->
                            <% if (product && product.images && product.images.length> 0) { %>
                                <div class="form-group">
                                    <label class="form-label">Current Images</label>
                                    <div
                                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
                                        <% product.images.forEach((image, index)=> { %>
                                            <div style="position: relative;">
                                                <img src="<%= image.url %>" alt="<%= image.alt %>"
                                                    style="width: 100%; height: 150px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd;">
                                                <form
                                                    action="/admin/products/<%= product._id %>/images/<%= index %>/delete"
                                                    method="POST" style="position: absolute; top: 5px; right: 5px;"
                                                    onsubmit="return confirm('Delete this image?');">
                                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                    <button type="submit" class="btn btn-sm btn-danger"
                                                        style="padding: 0.25rem 0.5rem;">
                                                        <i data-lucide="x" style="width: 14px; height: 14px;"></i>
                                                    </button>
                                                </form>
                                            </div>
                                            <% }); %>
                                    </div>
                                </div>
                                <% } %>

                                    <!-- Upload New Images -->
                                    <div class="form-group">
                                        <label for="images" class="form-label">
                                            <%= product ? 'Add More Images' : 'Product Images' %>
                                        </label>
                                        <input type="file" id="images" name="images" class="form-input" multiple
                                            accept="image/jpeg,image/jpg,image/png,image/webp">
                                        <small class="form-help">Upload up to 5 images (JPEG, PNG, WebP). Max 5MB per
                                            image.</small>
                                    </div>

                                    <div style="display: flex; gap: 1rem;">
                                        <div class="form-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="isActive" <%=product && product.isActive
                                                    ? 'checked' : (!product ? 'checked' : '' ) %>>
                                                <span>Active</span>
                                            </label>
                                        </div>

                                        <div class="form-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="isFeatured" <%=product &&
                                                    product.isFeatured ? 'checked' : '' %>>
                                                <span>Featured</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="flex gap-md">
                                        <button type="submit" class="btn btn-primary">
                                            <i data-lucide="save"></i>
                                            <%= product ? 'Update Product' : 'Create Product' %>
                                        </button>
                                        <a href="/admin/products" class="btn btn-secondary">
                                            <i data-lucide="x"></i>
                                            Cancel
                                        </a>
                                    </div>
                        </form>
    </div>
</div>